<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mega-Bot AI Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'brand-pink': '#DF1783',
          },
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
      body {
        font-family: 'Poppins', sans-serif;
      }
      @keyframes loading-anim {
          0% { background-position: -800px 0; }
          100% { background-position: 800px 0; }
      }
      .loading-bar-anim {
          background: linear-gradient(to right, #DF1783, #e2e8f0, #DF1783);
          background-size: 800px 100%;
          animation: loading-anim 3s linear infinite;
      }
      .dark .loading-bar-anim {
          background: linear-gradient(to right, #DF1783, #1f2937, #DF1783);
          background-size: 800px 100%;
          animation: loading-anim 3s linear infinite;
      }
      .markdown-content p { margin-bottom: 1rem; }
      .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 1rem; list-style: revert; }
      .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: 600; margin-bottom: 0.5rem; margin-top: 1.5rem; }
      .markdown-content h1 { font-size: 1.875rem; }
      .markdown-content h2 { font-size: 1.5rem; }
      .markdown-content h3 { font-size: 1.25rem; }
      .markdown-content code {
          background-color: #f1f1f1;
          padding: 0.2em 0.4em;
          font-size: 85%;
          border-radius: 6px;
          font-family: monospace;
      }
      .dark .markdown-content code { background-color: #374151; }
      .markdown-content pre { background-color: #f1f1f1; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
      .dark .markdown-content pre { background-color: #1f2937; }
      .markdown-content pre code { background-color: transparent; padding: 0; font-size: 100%; border-radius: 0; }
      .markdown-content a { color: #DF1783; text-decoration: underline; }
      .markdown-content blockquote { border-left: 4px solid #ccc; padding-left: 1rem; margin-left: 0; font-style: italic; color: #6b7280; }
      .dark .markdown-content blockquote { border-left-color: #4b5563; color: #9ca3af; }
  </style>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-markdown": "https://esm.sh/react-markdown@8.0.7",
        "remark-gfm": "https://esm.sh/remark-gfm@3.0.1"
      }
    }
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans bg-white dark:bg-gray-900 transition-colors duration-300">
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    // Debugging initialization
    console.log("Script loading started");
    
    try {
      import React from 'react';
      import { createRoot } from 'react-dom/client';
      import ReactMarkdown from 'react-markdown';
      import remarkGfm from 'remark-gfm';
      
      console.log("React imports successful");
    } catch (e) {
      console.error("Import error:", e);
      document.getElementById('root').innerHTML = `
        <div class="p-8 text-red-500">
          <h2 class="text-2xl font-bold">Loading Error</h2>
          <p>Failed to load required scripts. Please try refreshing the page.</p>
          <p class="mt-2 text-sm">${e.message}</p>
        </div>
      `;
      throw e;
    }

    const { useState, useCallback, useEffect, useRef } = React;
    const ReactDOM = { client: { createRoot } };

    // Constants
    const MessageSender = {
      USER: 'user',
      BOT: 'bot',
    };

    const SUGGESTIONS = [
      { text: "Outline a digital marketing strategy for a new e-commerce store.", icon: "store" },
      { text: "What are the key elements of a successful SaaS landing page?", icon: "web" },
      { text: "Generate 5 blog post ideas for a content marketing agency.", icon: "lightbulb_outline" },
      { text: "Explain SEO best practices for a small business website in 2024.", icon: "trending_up" },
    ];

    const MASTER_PROMPT = `You are an expert online business development assistant named Mega-Bot.
    Your goal is to provide actionable advice, strategies, and insights for entrepreneurs and businesses looking to grow online.
    Your responses should be practical, clear, and well-structured using markdown.`;

    const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
    const DEEPSEEK_MODEL = 'deepseek-chat';

    // DeepSeek Service
    const initializeDeepSeekService = (key) => {
      if (!key?.trim()) {
        throw new Error("API key is required");
      }
      localStorage.setItem('deepseek-api-key', key.trim());
      return key.trim();
    };

    const sendMessageToDeepSeek = async (message, fileContext, history, apiKey) => {
      console.log("Preparing API request...");
      
      const fullPrompt = fileContext 
        ? `File Context:\n${fileContext}\n\nUser Question: ${message}`
        : message;

      const messages = [
        { role: 'system', content: MASTER_PROMPT },
        ...history.filter(msg => msg.sender !== 'bot' || msg.text).map(msg => ({
          role: msg.sender === 'user' ? 'user' : 'assistant',
          content: msg.text
        })),
        { role: 'user', content: fullPrompt }
      ];

      console.log("Sending request with messages:", messages);

      const response = await fetch(DEEPSEEK_API_URL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        body: JSON.stringify({
          model: DEEPSEEK_MODEL,
          messages: messages,
          stream: true,
          temperature: 0.7
        })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        console.error("API Error:", error);
        throw new Error(error.error?.message || `API request failed with status ${response.status}`);
      }

      if (!response.body) {
        throw new Error("No response body received");
      }

      return response;
    };

    // Hooks
    const useTheme = () => {
      const [theme, setTheme] = useState(() => {
        const savedTheme = localStorage.getItem("mega-bot-theme");
        if (savedTheme === 'light' || savedTheme === 'dark') return savedTheme;
        return window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      });

      const toggleTheme = useCallback(() => {
        setTheme(prevTheme => (prevTheme === 'light' ? 'dark' : 'light'));
      }, []);

      useEffect(() => {
        const root = window.document.documentElement;
        root.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('mega-bot-theme', theme);
      }, [theme]);

      return [theme, toggleTheme];
    };

    // Components (shortened for brevity, same as previous implementation)
    const BotIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 text-brand-pink"><path fillRule="evenodd" d="M4.5 3.75a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3V6.75a3 3 0 0 0-3-3h-15Zm4.125 3.375a.75.75 0 0 0 0 1.5h6.75a.75.75 0 0 0 0-1.5h-6.75Zm0 3.75a.75.75 0 0 0 0 1.5h6.75a.75.75 0 0 0 0-1.5h-6.75Zm-2.625 3.375a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm12 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z" clipRule="evenodd" /></svg>);

    const UserIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 text-gray-500 dark:text-gray-400"><path fillRule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clipRule="evenodd" /></svg>);

    const LoadingIndicator = () => (
      <div className="flex flex-col gap-2 w-full">
        <div className="loading-bar-anim h-3 rounded-sm w-full"></div>
        <div className="loading-bar-anim h-3 rounded-sm w-4/5"></div>
        <div className="loading-bar-anim h-3 rounded-sm w-3/5"></div>
      </div>
    );

    // [Include all other components from previous implementation]

    // Main App Component
    const App = () => {
      console.log("App component rendering");
      
      const [theme, toggleTheme] = useTheme();
      const [messages, setMessages] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [isFileModalOpen, setFileModalOpen] = useState(false);
      const [uploadedFiles, setUploadedFiles] = useState([]);
      const [apiKey, setApiKey] = useState(() => {
        try {
          return localStorage.getItem('deepseek-api-key') || null;
        } catch (e) {
          console.error("Error reading API key:", e);
          return null;
        }
      });
      const [showApiKeyModal, setShowApiKeyModal] = useState(!apiKey);
      const [initError, setInitError] = useState(null);

      useEffect(() => {
        console.log("Initializing app...");
        if (!apiKey) {
          setShowApiKeyModal(true);
        }
      }, [apiKey]);

      const handleSaveApiKey = useCallback((key) => {
        try {
          console.log("Saving API key...");
          const validatedKey = initializeDeepSeekService(key);
          setApiKey(validatedKey);
          setShowApiKeyModal(false);
          setInitError(null);
        } catch (e) {
          console.error("Failed to save API key:", e);
          setInitError(e.message);
        }
      }, []);

      const handleSendMessage = useCallback(async (inputText) => {
        console.log("Sending message:", inputText);
        if (!inputText.trim() || isLoading || !apiKey) return;
        
        setIsLoading(true);
        const userMessage = { 
          id: Date.now(), 
          sender: 'user', 
          text: inputText 
        };
        const botMessage = { 
          id: Date.now() + 1, 
          sender: 'bot', 
          text: '', 
          isError: false 
        };
        
        setMessages(prev => [...prev, userMessage, botMessage]);
        
        try {
          const fileContext = uploadedFiles.map(f => `${f.name}:\n${f.content}`).join('\n\n');
          const response = await sendMessageToDeepSeek(inputText, fileContext, messages, apiKey);
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullResponse = '';
          let buffer = '';

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const chunks = buffer.split('\n\n');
            buffer = chunks.pop() || '';

            for (const chunk of chunks) {
              if (chunk.startsWith('data:') && !chunk.includes('[DONE]')) {
                try {
                  const data = JSON.parse(chunk.replace('data:','').trim());
                  const content = data.choices[0]?.delta?.content || '';
                  fullResponse += content;
                  setMessages(prev => prev.map(msg => 
                    msg.id === botMessage.id 
                      ? { ...msg, text: fullResponse } 
                      : msg
                  ));
                } catch (e) {
                  console.error('Error parsing chunk:', e);
                }
              }
            }
          }
        } catch (error) {
          console.error('API Error:', error);
          setMessages(prev => prev.map(msg => 
            msg.id === botMessage.id 
              ? { ...msg, text: `Error: ${error.message}`, isError: true } 
              : msg
          ));
          if (error.message.includes('401')) {
            localStorage.removeItem('deepseek-api-key');
            setApiKey(null);
            setShowApiKeyModal(true);
          }
        } finally {
          setIsLoading(false);
        }
      }, [apiKey, isLoading, messages, uploadedFiles]);

      // [Include other handler functions]

      if (initError) {
        return (
          <div className="p-8 text-red-500">
            <h2 className="text-2xl font-bold">Initialization Error</h2>
            <p>{initError}</p>
            <button 
              onClick={() => setShowApiKeyModal(true)}
              className="mt-4 px-4 py-2 bg-brand-pink text-white rounded"
            >
              Enter API Key
            </button>
          </div>
        );
      }

      return (
        <>
          <div className="flex flex-col h-screen max-h-screen bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200">
            {messages.length === 0 ? (
              <Header onSuggestionClick={handleSendMessage} />
            ) : (
              <ChatView messages={messages} />
            )}
            <TypingArea
              onSendMessage={handleSendMessage}
              isLoading={isLoading}
              theme={theme}
              toggleTheme={toggleTheme}
              onDeleteChat={() => {
                if (messages.length > 0 && window.confirm("Clear chat history?")) {
                  setMessages([]);
                }
              }}
              onOpenUploadModal={() => setFileModalOpen(true)}
              onOpenApiKeyModal={() => setShowApiKeyModal(true)}
              isApiConfigured={!!apiKey}
              uploadedFilesCount={uploadedFiles.length}
            />
          </div>
          
          {showApiKeyModal && (
            <ApiKeyModal
              onSave={handleSaveApiKey}
              onDelete={() => {
                localStorage.removeItem('deepseek-api-key');
                setApiKey(null);
              }}
              onClose={() => setShowApiKeyModal(false)}
              currentKey={apiKey}
            />
          )}
          
          {isFileModalOpen && (
            <FileUploadModal
              uploadedFiles={uploadedFiles}
              setUploadedFiles={setUploadedFiles}
              onClose={() => setFileModalOpen(false)}
            />
          )}
        </>
      );
    };

    // Render the app with error boundary
    try {
      console.log("Attempting to render React app");
      const root = ReactDOM.client.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
      console.log("React app rendered successfully");
    } catch (e) {
      console.error("Fatal rendering error:", e);
      document.getElementById('root').innerHTML = `
        <div class="p-8 text-red-500">
          <h2 class="text-2xl font-bold">Fatal Error</h2>
          <p>Failed to render application.</p>
          <p class="mt-2 text-sm">${e.message}</p>
          <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-brand-pink text-white rounded">
            Reload Page
          </button>
        </div>
      `;
    }
  </script>
</body>
</html>
